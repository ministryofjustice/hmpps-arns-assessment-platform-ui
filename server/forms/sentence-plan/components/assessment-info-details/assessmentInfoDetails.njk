{#
  Assessment Info Details Component
  Displays practitioner analysis, risk links, motivation, strengths (from SAN assessment)
  and scores (from HandoverContext/ARNS HANDOVER) for an area of need.

  Modes:
    - showAsDetails:
    -- true (default): collapsible details panel for goal pages
    -- false: direct content with score bars for About page accordion
  Layout:
    - fullWidth:
    -- false (default): wraps in two-thirds column
    -- true: no wrapper (when already in constrained layout)

  Params:
    personName       - Person's forename
    areaName         - Area of need name (e.g., "Accommodation")
    isError          - True if API call failed
    hasData          - True if at least one indicator has data
    isComplete       - True if section is marked complete
    roshLinked       - 'YES' | 'NO' | null
    roshText         - 'is' | 'is not' | null
    roshDetails      - Risk of serious harm details text
    reoffendingLinked - 'YES' | 'NO' | null
    reoffendingText  - 'is' | 'is not' | null
    reoffendingDetails - Risk of reoffending details text
    motivationText   - Motivation display text with person's name
    motivationBypassed - True if motivation question was not applicable
    strengthsLinked  - 'YES' | 'NO' | null
    strengthsText    - 'are' | 'are no' | null
    strengthsDetails - Strengths/protective factors details text
    missingItems     - Array of missing item descriptions
    hasMissingItems  - True if there are missing items
    score            - Numeric score value (null if not available)
    upperBound       - Maximum possible score for the area
    threshold        - Score threshold for high-scoring classification
    hasScore         - True if score, upperBound, and threshold are all available
    subArea          - Sub-area data object (for example, Lifestyle within Thinking, behaviours and attitudes) with title, score, upperBound, threshold
    hasSubArea       - True if sub-area data is available
    fullWidth        - True to skip the two-thirds wrapper
    showAsDetails    - True (default) wraps in govukDetails (used for create/change goal page), false renders content directly (used for about page)
#}

{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "sentence-plan/components/score-bar/needsScore.njk" import needsScore %}

{#- Build the content based on state -#}
{% set detailsContent %}
  {#- Error state -#}
  {% if params.isError and params.showAsDetails %}
    {{ govukWarningText({
      text: "There is a problem getting this information. Try reloading the page or try again later.",
      iconFallbackText: "Warning"
    }) }}

  {#- No data state -#}
  {% elif not params.hasData %}
    {% if params.showAsDetails %}
      {{ govukWarningText({
        text: "No information is available yet as the assessment has not been started for this area.",
        iconFallbackText: "Warning"
      }) }}
    {% else %}
      {{ govukWarningText({
        text: "No information is available yet",
        iconFallbackText: "Warning",
        classes: "govuk-warning-text--no-icon"
      }) }}
    {% endif %}

  {#- Has data -#}
  {% else %}
    {#- Incomplete warning -#}
    {% if not params.isComplete and params.showAsDetails%}
      {{ govukWarningText({
        text: "This area has not been marked as complete in the assessment yet, but you can check the latest information available below.",
        iconFallbackText: "Warning"
      }) }}
    {% endif %}

    {#- Risk of serious harm section -#}
    {% if params.roshLinked %}
      <p><strong>This area {{ params.roshText }} linked to RoSH (risk of serious harm)</strong></p>
      {% if params.roshDetails %}
        <p>{{ params.roshDetails }}</p>
      {% endif %}
    {% endif %}

    {#- Risk of reoffending section -#}
    {% if params.reoffendingLinked %}
      <p><strong>This area {{ params.reoffendingText }} linked to risk of reoffending</strong></p>
      {% if params.reoffendingDetails %}
        <p>{{ params.reoffendingDetails }}</p>
      {% endif %}
    {% endif %}

    {#- Motivation section -#}
    {% if params.motivationText %}
      <p><strong>Motivation to make changes in this area</strong></p>
      <p>{{ params.motivationText }}</p>
    {% elif params.motivationBypassed %}
      <p><strong>Motivation to make changes in this area</strong></p>
      <p>{{ params.personName }} did not have to answer this question.</p>
    {% endif %}

    {#- Strengths section -#}
    {% if params.strengthsLinked %}
      <p><strong>There {{ params.strengthsText }} strengths or protective factors related to this area</strong></p>
      {% if params.strengthsDetails %}
        <p>{{ params.strengthsDetails }}</p>
      {% endif %}
    {% endif %}

    {#- Score section (only shown on about page, not in collapsible details) -#}
    {% if params.hasScore and not params.showAsDetails %}
      <div class="govuk-!-margin-top-4">
        <p><strong>{{ params.areaName }} need score</strong></p>
        <p>{{ params.score }} out of {{ params.upperBound }}. (Scores above {{ params.threshold }} are high-scoring.)</p>
          {{ needsScore({
            score: params.score,
            upperBound: params.upperBound,
            thresholdValue: params.threshold
          }) }}
      </div>
    {% endif %}

    {#- Sub-area score section (for example, Lifestyle and associates within Thinking, behaviours and attitudes) -#}
    {% if params.hasSubArea and not params.showAsDetails %}
      <div class="govuk-!-margin-top-4">
        <p><strong>{{ params.subArea.title }} need score</strong></p>
        <p>{{ params.subArea.score }} out of {{ params.subArea.upperBound }}. (Scores above {{ params.subArea.threshold }} are high-scoring.)</p>
          {{ needsScore({
            score: params.subArea.score,
            upperBound: params.subArea.upperBound,
            thresholdValue: params.subArea.threshold
          }) }}
      </div>
    {% endif %}

    {#- Missing information section -#}
    {# NOTE: removed 'and not params.IsComplete' to account for edge case where score is not returned for some reason -#}
    {% if params.hasMissingItems %}
      {% if not params.showAsDetails %}
        <div class="govuk-inset-text">
      {% endif %}
      <p><strong>Missing information:</strong></p>
      <ul class="{{ 'govuk-list govuk-list--bullet' if params.showAsDetails else '' }}">
        {% for item in params.missingItems %}
          <li>{{ item }}</li>
        {% endfor %}
      </ul>
      {% if not params.showAsDetails %}
        </div>
      {% endif %}
    {% endif %}
  {% endif %}
{% endset %}

{% if params.showAsDetails %}
  {% set detailsComponent %}
    {{ govukDetails({
      summaryText: "View information from " + params.personName + "'s assessment",
      html: detailsContent,
      attributes: {
        "data-qa": "assessment-info-details"
      }
    }) }}
  {% endset %}

  {% if params.fullWidth %}
    {{ detailsComponent | safe }}
  {% else %}
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        {{ detailsComponent | safe }}
      </div>
    </div>
  {% endif %}
{% else %}
  {#- Render content directly without Details wrapper -#}
  <div data-qa="assessment-info-and-score-content">
    {{ detailsContent | safe }}
  </div>
{% endif %}
